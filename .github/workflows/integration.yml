name: Integration Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

env:
  CGO_ENABLED: 0

jobs:
  integration:
    name: Integration Tests (No CGO)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Set up Go
      uses: actions/setup-go@f111f3307d8850f501ac008e886eec1fd1932a34 # v5.3.0
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Build Titus
      run: make build

    - name: Run integration tests
      run: make integration-test

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: integration-test-results
        path: /tmp/titus-integration-*.json
        if-no-files-found: ignore

  static-binary:
    name: Static Binary Container Test (No CGO)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Set up Go
      uses: actions/setup-go@f111f3307d8850f501ac008e886eec1fd1932a34 # v5.3.0
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Build static binary
      run: |
        # Build with CGO disabled (pure Go, truly static)
        CGO_ENABLED=0 go build \
          -ldflags '-s -w' \
          -o titus-static ./cmd/titus

        # Verify it's static
        file titus-static
        ldd titus-static 2>&1 || true

    - name: Verify static linking
      run: |
        # ldd should say "not a dynamic executable" for truly static binaries
        if ldd ./titus-static 2>&1 | grep -q "not a dynamic executable"; then
          echo "✓ Binary is statically linked (pure Go, no CGO)"
        elif ldd ./titus-static 2>&1 | grep -q "statically linked"; then
          echo "✓ Binary is statically linked"
        else
          echo "Warning: Binary may have dynamic dependencies"
          ldd ./titus-static 2>&1 || true
        fi

    - name: Test in Alpine container
      run: |
        # Pull Alpine image
        docker pull alpine:3.19

        # Test --help works
        docker run --rm \
          -v "$(pwd)/titus-static:/titus:ro" \
          alpine:3.19 /titus --help

        # Test actual scan (use :memory: since SQLite requires CGO)
        docker run --rm \
          -v "$(pwd)/titus-static:/titus:ro" \
          -v "$(pwd)/testdata:/testdata:ro" \
          alpine:3.19 /titus scan /testdata/secrets --format=json --output :memory:

    - name: Upload static binary on success
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: titus-static-linux-amd64
        path: titus-static
