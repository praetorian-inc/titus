# Titus Release Workflow - Creates portable binaries for all platforms
name: Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.1)'
        required: true
        type: string

permissions:
  contents: write

env:
  VERSION: ${{ inputs.version || github.ref_name }}

jobs:
  # Build Linux amd64 with Intel hyperscan
  build-linux-amd64:
    name: Build Linux amd64
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ragel pkg-config libboost-dev

    - name: Build hyperscan static library
      run: |
        git clone --depth 1 --branch v5.4.2 https://github.com/intel/hyperscan.git /tmp/hyperscan
        cd /tmp/hyperscan
        mkdir build && cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=/usr/local
        make -j$(nproc)
        sudo make install
        ls -la /usr/local/lib/libhs*.a

    - name: Build binary
      env:
        CGO_ENABLED: "1"
        CGO_CFLAGS: "-I/usr/local/include"
        CGO_LDFLAGS: "-L/usr/local/lib -lhs -lstdc++ -lm"
      run: |
        mkdir -p dist
        GOWORK=off go build -o dist/titus-linux-amd64 ./cmd/titus
        chmod +x dist/titus-linux-amd64
        file dist/titus-linux-amd64
        ldd dist/titus-linux-amd64

    - name: Verify binary runs
      run: dist/titus-linux-amd64 version

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-linux-amd64
        path: dist/titus-linux-amd64

  # Build Linux arm64 with vectorscan (ARM port of hyperscan)
  build-linux-arm64:
    name: Build Linux arm64
    runs-on: ubuntu-22.04-arm

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ragel pkg-config libboost-dev

    - name: Build vectorscan static library
      run: |
        git clone --depth 1 --branch vectorscan/5.4.11 https://github.com/VectorCamp/vectorscan.git /tmp/vectorscan
        cd /tmp/vectorscan
        mkdir build && cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=/usr/local
        make -j$(nproc)
        sudo make install
        ls -la /usr/local/lib/libhs*.a

    - name: Build binary
      env:
        CGO_ENABLED: "1"
        CGO_CFLAGS: "-I/usr/local/include"
        CGO_LDFLAGS: "-L/usr/local/lib -lhs -lstdc++ -lm"
      run: |
        mkdir -p dist
        GOWORK=off go build -o dist/titus-linux-arm64 ./cmd/titus
        chmod +x dist/titus-linux-arm64
        file dist/titus-linux-arm64
        ldd dist/titus-linux-arm64

    - name: Verify binary runs
      run: dist/titus-linux-arm64 version

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-linux-arm64
        path: dist/titus-linux-arm64

  # Build macOS binaries
  build-macos:
    name: Build macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-14
            hs_package: vectorscan
          # macOS Intel builds disabled - macos-12 runner unavailable
          # Intel Mac users can build from source or use Rosetta 2 on ARM Macs

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: |
        brew install ${{ matrix.hs_package }} pkg-config
        HS_PREFIX=$(brew --prefix ${{ matrix.hs_package }})
        echo "HS_PREFIX=${HS_PREFIX}" >> $GITHUB_ENV
        ls -la ${HS_PREFIX}/lib/

    - name: Build binary
      env:
        CGO_ENABLED: "1"
      run: |
        export CGO_CFLAGS="-I${HS_PREFIX}/include/hs"
        export CGO_LDFLAGS="-L${HS_PREFIX}/lib -lhs -lc++"

        mkdir -p dist
        GOWORK=off go build -o dist/titus-darwin-${{ matrix.arch }} ./cmd/titus
        chmod +x dist/titus-darwin-${{ matrix.arch }}
        file dist/titus-darwin-${{ matrix.arch }}
        otool -L dist/titus-darwin-${{ matrix.arch }}

    - name: Verify binary runs
      run: |
        dist/titus-darwin-${{ matrix.arch }} version

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-darwin-${{ matrix.arch }}
        path: dist/titus-darwin-${{ matrix.arch }}

  # Build Windows binary using vcpkg
  build-windows:
    name: Build Windows amd64
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install hyperscan via vcpkg
      run: |
        vcpkg install hyperscan:x64-windows-static
        vcpkg integrate install

    - name: Create pkg-config file for hyperscan
      run: |
        $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT -replace '\\','/'
        $prefix = "$vcpkgRoot/installed/x64-windows-static"
        $pkgconfigDir = "$prefix/lib/pkgconfig"
        New-Item -ItemType Directory -Force -Path $pkgconfigDir
        $pcContent = "prefix=$prefix`nexec_prefix=`${prefix}`nlibdir=`${prefix}/lib`nincludedir=`${prefix}/include/hs`n`nName: libhs`nDescription: Hyperscan regex library`nVersion: 5.4.2`nLibs: -L`${libdir} -lhs`nCflags: -I`${includedir}"
        $pcContent | Out-File -FilePath "$pkgconfigDir/libhs.pc" -Encoding ASCII -NoNewline
        Write-Output "--- pkg-config file content ---"
        Get-Content "$pkgconfigDir/libhs.pc"
        Write-Output "--- include directory ---"
        dir "$prefix/include/hs"

    - name: Build binary
      run: |
        $env:CGO_ENABLED = "1"
        $env:PKG_CONFIG_PATH = "$env:VCPKG_INSTALLATION_ROOT/installed/x64-windows-static/lib/pkgconfig"
        $env:GOWORK = "off"
        mkdir -p dist
        go build -o dist/titus-windows-amd64.exe ./cmd/titus
        Get-ChildItem dist/

    - name: Verify binary runs
      run: |
        dist/titus-windows-amd64.exe version

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-windows-amd64
        path: dist/titus-windows-amd64.exe

  # Build Burp extension JAR - temporarily always runs to register workflow
  build-burp:
    name: Build Burp Extension
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build JAR
      working-directory: burp
      run: ./gradlew shadowJar

    - name: Rename JAR with version
      run: |
        mkdir -p dist
        cp burp/build/libs/titus-burp-*-all.jar dist/titus-burp-${VERSION}.jar

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-burp-extension
        path: dist/titus-burp-*.jar

  # Build browser extension zip
  build-extension:
    name: Build Browser Extension
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Build WASM
      env:
        CGO_ENABLED: "0"
      run: |
        GOWORK=off GOOS=js GOARCH=wasm go build -o extension/lib/titus.wasm ./wasm

    - name: Create extension zip
      run: |
        cd extension
        zip -r ../titus-browser-extension-${VERSION}.zip . -x "*.DS_Store" -x "*/.git/*" -x "test/*" -x ".feature-development/*"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-browser-extension
        path: titus-browser-extension-*.zip

  # Create GitHub release with all artifacts (skipped on main branch push)
  release:
    name: Create Release
    needs: [build-linux-amd64, build-linux-arm64, build-macos, build-windows, build-burp, build-extension]
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release

        # Move binaries
        mv artifacts/titus-linux-amd64/titus-linux-amd64 release/
        mv artifacts/titus-linux-arm64/titus-linux-arm64 release/ || true
        mv artifacts/titus-darwin-arm64/titus-darwin-arm64 release/
        # macOS Intel disabled - build from source if needed
        mv artifacts/titus-windows-amd64/titus-windows-amd64.exe release/

        # Move JAR and extension
        mv artifacts/titus-burp-extension/*.jar release/
        mv artifacts/titus-browser-extension/*.zip release/

        # Create checksums
        cd release
        sha256sum * > checksums.txt

        ls -la

    - name: Generate release notes
      run: |
        cat > release_notes.md << 'NOTES_EOF'
        ## Titus Secret Scanner

        ### Downloads

        | Platform | Architecture | File |
        |----------|-------------|------|
        | Linux | x64 | `titus-linux-amd64` |
        | Linux | arm64 | `titus-linux-arm64` |
        | macOS | Apple Silicon | `titus-darwin-arm64` |
        | macOS | Intel | Build from source |
        | Windows | x64 | `titus-windows-amd64.exe` |

        ### Extensions

        | Extension | File | Notes |
        |-----------|------|-------|
        | Burp Suite | `titus-burp.jar` | Load in Extensions â†’ Add |
        | Chrome/Firefox | `titus-browser-extension.zip` | Load as unpacked extension |

        ### Installation

        Download the appropriate binary for your platform from the assets below.

        **Linux/macOS:**
        ```bash
        chmod +x titus-*
        sudo mv titus-* /usr/local/bin/titus
        ```

        **Windows:** Run the .exe directly or add to PATH.

        ### Checksums

        See `checksums.txt` for SHA256 checksums of all files.
        NOTES_EOF
        sed 's/^        //' release_notes.md > release_notes_clean.md && mv release_notes_clean.md release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.VERSION }}
        body_path: release_notes.md
        files: release/*
        draft: false
        prerelease: ${{ contains(env.VERSION, '-alpha') || contains(env.VERSION, '-beta') || contains(env.VERSION, '-rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
