# Titus Release Workflow - Creates portable binaries for all platforms
name: Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - '.github/workflows/release-new.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.1)'
        required: true
        type: string

permissions:
  contents: write

env:
  VERSION: ${{ inputs.version || github.ref_name }}

jobs:
  # Build Linux binaries with static hyperscan
  build-linux:
    name: Build Linux ${{ matrix.arch }}
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-22.04
          - arch: arm64
            runner: ubuntu-22.04-arm

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ragel pkg-config libboost-dev

    - name: Build hyperscan static library
      run: |
        git clone --depth 1 --branch v5.4.2 https://github.com/intel/hyperscan.git /tmp/hyperscan
        cd /tmp/hyperscan
        mkdir build && cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=/usr/local
        make -j$(nproc)
        sudo make install
        ls -la /usr/local/lib/libhs*.a

    - name: Build binary
      env:
        CGO_ENABLED: "1"
        CGO_CFLAGS: "-I/usr/local/include"
        CGO_LDFLAGS: "-L/usr/local/lib -lhs -lstdc++ -lm"
      run: |
        mkdir -p dist
        GOWORK=off go build -o dist/titus-linux-${{ matrix.arch }} ./cmd/titus
        chmod +x dist/titus-linux-${{ matrix.arch }}
        file dist/titus-linux-${{ matrix.arch }}
        ldd dist/titus-linux-${{ matrix.arch }}

    - name: Verify binary runs
      run: |
        dist/titus-linux-${{ matrix.arch }} version

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-linux-${{ matrix.arch }}
        path: dist/titus-linux-${{ matrix.arch }}

  # Build macOS binaries
  build-macos:
    name: Build macOS ${{ matrix.arch }}
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-14
            hs_package: vectorscan
          - arch: amd64
            runner: macos-15
            hs_package: hyperscan

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install dependencies
      run: |
        brew install ${{ matrix.hs_package }} pkg-config
        HS_PREFIX=$(brew --prefix ${{ matrix.hs_package }})
        echo "HS_PREFIX=${HS_PREFIX}" >> $GITHUB_ENV
        ls -la ${HS_PREFIX}/lib/

    - name: Build binary
      env:
        CGO_ENABLED: "1"
      run: |
        export CGO_CFLAGS="-I${HS_PREFIX}/include/hs"
        export CGO_LDFLAGS="-L${HS_PREFIX}/lib -lhs -lc++"

        mkdir -p dist
        GOWORK=off go build -o dist/titus-darwin-${{ matrix.arch }} ./cmd/titus
        chmod +x dist/titus-darwin-${{ matrix.arch }}
        file dist/titus-darwin-${{ matrix.arch }}
        otool -L dist/titus-darwin-${{ matrix.arch }}

    - name: Verify binary runs
      run: |
        dist/titus-darwin-${{ matrix.arch }} version

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-darwin-${{ matrix.arch }}
        path: dist/titus-darwin-${{ matrix.arch }}

  # Build Windows binary using vcpkg
  build-windows:
    name: Build Windows amd64
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install hyperscan via vcpkg
      run: |
        vcpkg install hyperscan:x64-windows-static
        vcpkg integrate install

    - name: Build binary
      env:
        CGO_ENABLED: "1"
        CGO_CFLAGS: "-I${{ env.VCPKG_INSTALLATION_ROOT }}/installed/x64-windows-static/include"
        CGO_LDFLAGS: "-L${{ env.VCPKG_INSTALLATION_ROOT }}/installed/x64-windows-static/lib -lhs -lstdc++"
      run: |
        mkdir -p dist
        $env:GOWORK = "off"
        go build -o dist/titus-windows-amd64.exe ./cmd/titus
        Get-ChildItem dist/

    - name: Verify binary runs
      run: |
        dist/titus-windows-amd64.exe version

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-windows-amd64
        path: dist/titus-windows-amd64.exe

  # Build Burp extension JAR
  build-burp:
    name: Build Burp Extension
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build JAR
      working-directory: burp
      run: ./gradlew shadowJar

    - name: Rename JAR with version
      run: |
        mkdir -p dist
        cp burp/build/libs/titus-burp-*-all.jar dist/titus-burp-${VERSION}.jar

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-burp-extension
        path: dist/titus-burp-*.jar

  # Build browser extension zip
  build-extension:
    name: Build Browser Extension
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Build WASM
      env:
        CGO_ENABLED: "0"
      run: |
        GOWORK=off GOOS=js GOARCH=wasm go build -o extension/lib/titus.wasm ./wasm

    - name: Create extension zip
      run: |
        cd extension
        zip -r ../titus-browser-extension-${VERSION}.zip . -x "*.DS_Store" -x "*/.git/*" -x "test/*" -x ".feature-development/*"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-browser-extension
        path: titus-browser-extension-*.zip

  # Create GitHub release with all artifacts
  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: [build-linux, build-macos, build-windows, build-burp, build-extension]
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release

        # Move binaries
        mv artifacts/titus-linux-amd64/titus-linux-amd64 release/
        mv artifacts/titus-linux-arm64/titus-linux-arm64 release/ || true
        mv artifacts/titus-darwin-arm64/titus-darwin-arm64 release/
        mv artifacts/titus-darwin-amd64/titus-darwin-amd64 release/
        mv artifacts/titus-windows-amd64/titus-windows-amd64.exe release/

        # Move JAR and extension
        mv artifacts/titus-burp-extension/*.jar release/
        mv artifacts/titus-browser-extension/*.zip release/

        # Create checksums
        cd release
        sha256sum * > checksums-${VERSION}.txt

        ls -la

    - name: Generate release notes
      run: |
        cat << EOF > release_notes.md
## Titus Secret Scanner ${VERSION}

### Downloads

| Platform | Architecture | File |
|----------|-------------|------|
| Linux | x64 | \`titus-linux-amd64\` |
| Linux | arm64 | \`titus-linux-arm64\` |
| macOS | Apple Silicon | \`titus-darwin-arm64\` |
| macOS | Intel | \`titus-darwin-amd64\` |
| Windows | x64 | \`titus-windows-amd64.exe\` |

### Extensions

| Extension | File | Notes |
|-----------|------|-------|
| Burp Suite | \`titus-burp-${VERSION}.jar\` | Load in Extensions → Add |
| Chrome/Firefox | \`titus-browser-extension-${VERSION}.zip\` | Load as unpacked extension |

### Installation

**CLI Binary:**
\`\`\`bash
# Linux x64
curl -L -o titus https://github.com/praetorian-inc/titus/releases/download/${VERSION}/titus-linux-amd64
chmod +x titus
sudo mv titus /usr/local/bin/

# macOS Apple Silicon
curl -L -o titus https://github.com/praetorian-inc/titus/releases/download/${VERSION}/titus-darwin-arm64
chmod +x titus
sudo mv titus /usr/local/bin/

# Windows (PowerShell)
Invoke-WebRequest -Uri https://github.com/praetorian-inc/titus/releases/download/${VERSION}/titus-windows-amd64.exe -OutFile titus.exe
\`\`\`

**Burp Extension:**
1. Download the titus binary for your platform and place it at \`~/.titus/titus\`
2. Load the JAR in Burp Suite (Extensions → Add)

**Browser Extension:**
1. Extract the zip
2. Chrome: Go to \`chrome://extensions/\`, enable Developer mode, click "Load unpacked"
3. Firefox: Go to \`about:debugging\`, click "Load Temporary Add-on"

### Checksums

See \`checksums-${VERSION}.txt\` for SHA256 checksums of all files.
EOF

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.VERSION }}
        body_path: release_notes.md
        files: release/*
        draft: false
        prerelease: ${{ contains(env.VERSION, '-alpha') || contains(env.VERSION, '-beta') || contains(env.VERSION, '-rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
