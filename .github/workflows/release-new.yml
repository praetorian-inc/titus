# Titus Release Workflow - Creates portable binaries for all platforms
#
# Builds two variants:
# 1. Pure Go (CGO_ENABLED=0) - Maximum portability, regexp2-based matching
# 2. Vectorscan-enabled (CGO_ENABLED=1) - High-performance SIMD regex with Hyperscan
#
name: Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.1)'
        required: true
        type: string

permissions:
  contents: write

env:
  VERSION: ${{ inputs.version || github.ref_name }}

jobs:
  # Build binaries for all platforms using pure Go (matrix strategy)
  build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            runner: ubuntu-22.04
            artifact: titus-linux-amd64
            native: true
          - goos: linux
            goarch: arm64
            runner: ubuntu-22.04
            artifact: titus-linux-arm64
            native: false
          - goos: darwin
            goarch: arm64
            runner: macos-14
            artifact: titus-darwin-arm64
            native: true
          - goos: darwin
            goarch: amd64
            runner: macos-15-intel
            artifact: titus-darwin-amd64
            native: true
          - goos: windows
            goarch: amd64
            runner: windows-2022
            artifact: titus-windows-amd64.exe
            native: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Build binary
      env:
        CGO_ENABLED: "0"
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        mkdir -p dist
        GOWORK=off go build -ldflags '-s -w' -o dist/${{ matrix.artifact }} ./cmd/titus
      shell: bash

    - name: Make binary executable (Unix)
      if: matrix.goos != 'windows'
      run: chmod +x dist/${{ matrix.artifact }}
      shell: bash

    - name: Verify binary metadata (Unix)
      if: matrix.goos != 'windows'
      run: file dist/${{ matrix.artifact }}
      shell: bash

    - name: Verify binary runs
      if: matrix.native
      run: dist/${{ matrix.artifact }} version
      shell: bash

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: dist/${{ matrix.artifact }}

  # Build vectorscan-enabled binaries (high-performance SIMD regex)
  # Only available on platforms where vectorscan/hyperscan can be compiled
  build-vectorscan:
    name: Build Vectorscan ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            runner: ubuntu-22.04
            artifact: titus-linux-amd64-vectorscan
            native: true
          - goos: darwin
            goarch: arm64
            runner: macos-14
            artifact: titus-darwin-arm64-vectorscan
            native: true
          - goos: darwin
            goarch: amd64
            runner: macos-15-intel
            artifact: titus-darwin-amd64-vectorscan
            native: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Install vectorscan (Linux)
      if: matrix.goos == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libhyperscan-dev

    - name: Install vectorscan (macOS)
      if: matrix.goos == 'darwin'
      run: |
        brew install vectorscan

    - name: Build vectorscan binary
      env:
        CGO_ENABLED: "1"
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        mkdir -p dist
        GOWORK=off go build -tags "cgo vectorscan" -ldflags '-s -w' -o dist/${{ matrix.artifact }} ./cmd/titus
      shell: bash

    - name: Make binary executable
      run: chmod +x dist/${{ matrix.artifact }}
      shell: bash

    - name: Verify binary metadata
      run: file dist/${{ matrix.artifact }}
      shell: bash

    - name: Verify binary runs
      if: matrix.native
      run: dist/${{ matrix.artifact }} version
      shell: bash

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: dist/${{ matrix.artifact }}

  # Build Burp extension JAR
  build-burp:
    name: Build Burp Extension
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build JAR
      working-directory: burp
      run: ./gradlew shadowJar

    - name: Rename JAR with version
      run: |
        mkdir -p dist
        cp burp/build/libs/titus-burp-*-all.jar dist/titus-burp-${VERSION}.jar

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-burp-extension
        path: dist/titus-burp-*.jar

  # Build browser extension zip
  build-extension:
    name: Build Browser Extension
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Build WASM
      env:
        CGO_ENABLED: "0"
      run: |
        GOWORK=off GOOS=js GOARCH=wasm go build -o extension/lib/titus.wasm ./wasm

    - name: Create extension zip
      run: |
        cd extension
        zip -r ../titus-browser-extension-${VERSION}.zip . -x "*.DS_Store" -x "*/.git/*" -x "test/*" -x ".feature-development/*"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: titus-browser-extension
        path: titus-browser-extension-*.zip

  # Create GitHub release with all artifacts (skipped on main branch push)
  release:
    name: Create Release
    needs: [build, build-vectorscan, build-burp, build-extension]
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release

        # Move pure Go binaries (portable, no CGO)
        mv artifacts/titus-linux-amd64/titus-linux-amd64 release/
        mv artifacts/titus-linux-arm64/titus-linux-arm64 release/
        mv artifacts/titus-darwin-arm64/titus-darwin-arm64 release/
        mv artifacts/titus-darwin-amd64/titus-darwin-amd64 release/
        mv artifacts/titus-windows-amd64.exe/titus-windows-amd64.exe release/

        # Move vectorscan-enabled binaries (high-performance)
        mv artifacts/titus-linux-amd64-vectorscan/titus-linux-amd64-vectorscan release/
        mv artifacts/titus-darwin-arm64-vectorscan/titus-darwin-arm64-vectorscan release/
        mv artifacts/titus-darwin-amd64-vectorscan/titus-darwin-amd64-vectorscan release/

        # Move JAR and extension
        mv artifacts/titus-burp-extension/*.jar release/
        mv artifacts/titus-browser-extension/*.zip release/

        # Create checksums
        cd release
        sha256sum * > checksums.txt

        ls -la

    - name: Generate release notes
      run: |
        cat > release_notes.md << 'NOTES_EOF'
        ## Titus Secret Scanner

        ### Downloads

        #### Standard Binaries (Pure Go - Portable)

        These binaries use regexp2 for pattern matching and work on any system without dependencies.

        | Platform | Architecture | File |
        |----------|-------------|------|
        | Linux | x64 | `titus-linux-amd64` |
        | Linux | arm64 | `titus-linux-arm64` |
        | macOS | Apple Silicon | `titus-darwin-arm64` |
        | macOS | Intel | `titus-darwin-amd64` |
        | Windows | x64 | `titus-windows-amd64.exe` |

        #### High-Performance Binaries (Vectorscan-enabled)

        These binaries use Intel Hyperscan/Vectorscan for SIMD-accelerated multi-pattern matching.
        ~2-3x faster for large scans. Requires vectorscan/hyperscan library on your system.

        | Platform | Architecture | File |
        |----------|-------------|------|
        | Linux | x64 | `titus-linux-amd64-vectorscan` |
        | macOS | Apple Silicon | `titus-darwin-arm64-vectorscan` |
        | macOS | Intel | `titus-darwin-amd64-vectorscan` |

        **Installing vectorscan dependency:**
        - Linux: `apt install libhyperscan5` or `dnf install hyperscan`
        - macOS: `brew install vectorscan`

        ### Extensions

        | Extension | File | Notes |
        |-----------|------|-------|
        | Burp Suite | `titus-burp.jar` | Load in Extensions â†’ Add |
        | Chrome/Firefox | `titus-browser-extension.zip` | Load as unpacked extension |

        ### Installation

        Download the appropriate binary for your platform from the assets below.

        **Linux/macOS:**
        ```bash
        chmod +x titus-*
        sudo mv titus-* /usr/local/bin/titus
        ```

        **Windows:** Run the .exe directly or add to PATH.

        ### Checksums

        See `checksums.txt` for SHA256 checksums of all files.
        NOTES_EOF
        sed 's/^        //' release_notes.md > release_notes_clean.md && mv release_notes_clean.md release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.VERSION }}
        body_path: release_notes.md
        files: release/*
        draft: false
        prerelease: ${{ contains(env.VERSION, '-alpha') || contains(env.VERSION, '-beta') || contains(env.VERSION, '-rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
